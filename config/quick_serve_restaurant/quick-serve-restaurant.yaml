# yaml-language-server: $schema=../../schemas/model_config_schema.json

# =============================================================================
# Multi-Agent AI Orchestration Framework Configuration
# =============================================================================
# This configuration file defines the complete setup for the multi-agent system
# including schemas, resources, tools, agents, and orchestration patterns.

# =============================================================================
# DATABRICKS SCHEMAS
# =============================================================================
# Define Unity Catalog schemas where data and functions will be stored
schemas:
  qsr_schema: &qsr_schema
    catalog_name: retail_consumer_goods                    # Unity Catalog name
    schema_name: quick_serve_restaurant                    # Schema within the catalog
    permissions:                              # Access permissions for the schema
      - principals: [users]                   # Grant access to all users
        privileges:
          - ALL_PRIVILEGES                    # Full permissions for demo purposes

# =============================================================================
# RESOURCES CONFIGURATION
# =============================================================================
# Define all resources needed by the multi-agent system including LLMs,
# vector stores, databases, tables, and other Databricks resources

resources:
  # ---------------------------------------------------------------------------
  # LANGUAGE MODELS (LLMs)
  # ---------------------------------------------------------------------------
  # Configure different LLMs for various purposes in the agent system
  llms:
    # Primary LLM for general tasks
    default_llm: &default_llm
      name: databricks-claude-3-7-sonnet  # Databricks serving endpoint name
      temperature: 0.1                              # Low temperature for consistent responses
      max_tokens: 8192                              # Maximum tokens per response

    # LLM optimized for tool calling and function execution
    tool_calling_llm: &tool_calling_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.1
      max_tokens: 8192
      fallbacks:                                     # Fallback models if primary fails
        - databricks-meta-llama-3-3-70b-instruct

    # LLM for complex reasoning tasks
    reasoning_llm: &reasoning_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.1
      max_tokens: 8192

    # LLM for evaluating and judging responses (guardrails)
    judge_llm: &judge_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.5                              # Higher temperature for diverse judgments
      max_tokens: 8192

    # Embedding model for vector search and semantic similarity
    embedding_model: &embedding_model
      name: databricks-gte-large-en                 # Text embedding model

  # ---------------------------------------------------------------------------
  # VECTOR STORES
  # ---------------------------------------------------------------------------
  # Configure vector databases for semantic search and retrieval
  vector_stores:
    # Product information vector store for similarity search
    items_description_vector_store: &items_description_vector_store
      embedding_model: *embedding_model             # Reference to embedding model above
      endpoint:                                     # Vector search endpoint configuration
        name: one-env-shared-endpoint-12            # Databricks vector search endpoint
        type: STANDARD                              # Endpoint type (STANDARD or OPTIMIZED_STORAGE)
      index:                                        # Vector search index configuration
        schema: *qsr_schema                      # Unity Catalog schema for the index
        name: items_description_vs_index                        # Index name
      source_table:                                 # Table containing source data
        schema: *qsr_schema
        name: items_description
      primary_key: item_name                       # Primary key column
      doc_uri: ~                                    # Optional document URI column (null in this case)
      embedding_source_column: item_review          # Column to create embeddings from
      columns:                                      # Columns to include in vector store
        - item_name
        - item_review



  # ---------------------------------------------------------------------------
  # TABLES
  # ---------------------------------------------------------------------------
  # Define Unity Catalog tables used by the system
  tables:
    # Product catalog table
    fulfil_item_orders: &fulfil_item_orders
      schema: *qsr_schema                        # Reference to schema defined above
      name: fulfil_item_orders                                # Table name
    items_description_table: &items_description_table
      schema: *qsr_schema                        # Reference to schema defined above
      name: items_description                                 # Table name
    


  # ---------------------------------------------------------------------------
  # FUNCTIONS
  # ---------------------------------------------------------------------------
  # Define Unity Catalog functions for data operations
  functions:
    insert_coffee_order: &insert_coffee_order
      schema: *qsr_schema
      name: insert_coffee_order             
    match_item_by_description_and_price: &match_item_by_description_and_price
      schema: *qsr_schema
      name: match_item_by_description_and_price                  
    match_historical_item_order_by_date: &match_historical_item_order_by_date
      schema: *qsr_schema
      name: match_historical_item_order_by_date                    
    lookup_items_by_descriptions: &lookup_items_by_descriptions
      schema: *qsr_schema
      name: lookup_items_by_descriptions                   


  # ---------------------------------------------------------------------------
  # WAREHOUSES
  # ---------------------------------------------------------------------------
  # Define SQL warehouses for query execution
  warehouses:
    # Shared warehouse for general query execution
    shared_endpoint_warehouse: &shared_endpoint_warehouse
      name: "Shared Endpoint Warehouse"             # Human-readable name
      description: "A warehouse for shared endpoints"  # Description
      warehouse_id: 148ccb90800933a1                # Databricks warehouse ID

  # ---------------------------------------------------------------------------
  # DATABASES
  # ---------------------------------------------------------------------------
  # Configure external databases (e.g., PostgreSQL for checkpoints and memory)
  # Supports both traditional user/password auth and OAuth2 client credentials
  databases:
    # PostgreSQL database for agent memory and checkpoints
    qsr_database: &qsr_database
      name: "Retail Database"                                  
      description: "Database for agent memory and checkpoints" 
      
      # Database connection parameters
      # These can be set via environment variables or Databricks secrets
      host:                                                 
        default_value: localhost                                             
        variables:
          - env: PGHOST                              # Environment variable
          - scope: retail_ai                         # Databricks secret scope
            secret: PGHOST                           # Secret name
      port: 
        default_value: 5432
        variables:
        - env: PGPORT 
        - scope: retail_ai
          secret: PGPORT
      database: 
        default_value: databricks_postgres           # Default database name
        variables:
        - env: PGDATABASE 
        - scope: retail_ai
          secret: PGDATABASE


      # Traditional PostgreSQL authentication (commented out)
      # Uncomment and configure if using direct database auth instead of OAuth2
      # user: 
      #   default_value: postgres
      #   variables:
      #   - env: PGUSER 
      #   - scope: qsr_ai
      #     secret: PGUSER
      # password: 
      #   default_value: postgres
      #   variables:
      #   - env: PGPASSWORD 
      #   - scope: qsr_ai
      #     secret: PGPASSWORD

      # OAuth2 client credentials for Databricks authentication
      # Used to generate access tokens for database connections
      # This approach is recommended for Databricks environments
      client_id:
        variables:
          - env: RETAIL_AI_DATABRICKS_CLIENT_ID      # Service principal client ID
          - scope: retail_ai
            secret: RETAIL_AI_DATABRICKS_CLIENT_ID
      client_secret:
        variables:
          - env: RETAIL_AI_DATABRICKS_CLIENT_SECRET  # Service principal secret
          - scope: retail_ai
            secret: RETAIL_AI_DATABRICKS_CLIENT_SECRET
      workspace_host:
        variables:
          - env: RETAIL_AI_DATABRICKS_HOST           # Databricks workspace URL
          - scope: retail_ai
            secret: RETAIL_AI_DATABRICKS_HOST
          
      # Optional: Additional PostgreSQL connection parameters
      # Uncomment and modify as needed for your specific setup
      # connection_kwargs:                            # Additional connection parameters
      #   autocommit: True                            # Enable autocommit mode
      #   prepare_threshold: 0                        # Disable prepared statements
      #   sslmode: require                            # Require SSL connection
      #   connect_timeout: 10                         # Connection timeout in seconds
      
      # Optional: Connection pool configuration
      # max_pool_size: 20                             # Maximum connections in pool
      # timeout: 5                                    # Connection timeout in seconds

# =============================================================================
# RETRIEVERS CONFIGURATION
# =============================================================================
# Configure retrieval systems for semantic search and information retrieval

retrievers:
  # Product information retriever using vector search
  items_description_retriever: &items_description_retriever
    vector_store: *items_description_vector_store            # Reference to vector store defined above
    columns:                                        # Columns to return in search results
      - item_name
      - item_review
    search_parameters:                              # Search configuration
      num_results: 10                               # Maximum number of results to return
      filters: {}                                   # Additional filters (empty in this case)
      query_type: ANN                               # Approximate Nearest Neighbor search

# =============================================================================
# TOOLS CONFIGURATION
# =============================================================================
# Define tools that agents can use to perform various tasks
# Tools can be of different types: python, factory, unity_catalog, or mcp

tools:


  match_item_by_description_and_price_tool: &match_item_by_description_and_price_tool
    name: match_item_by_description_and_price_uc
    function:
      type: unity_catalog
      <<: *match_item_by_description_and_price

  match_historical_item_order_by_date_tool: &match_historical_item_order_by_date_tool
    name: match_historical_item_order_by_date_uc
    function:
      type: unity_catalog
      <<: *match_historical_item_order_by_date

  lookup_items_by_descriptions_tool: &lookup_items_by_descriptions_tool
    name: lookup_items_by_descriptions_uc
    function:
      type: unity_catalog
      <<: *lookup_items_by_descriptions

  insert_coffee_order_tool: &insert_coffee_order_tool
    name: insert_coffee_order
    function:
      type: factory
      name: quick_serve_restaurant.tools.insert_coffee_order_tool
      args:
        variables:
          - env: RETAIL_AI_DATABRICKS_HOST          
          - scope: retail_ai
            secret: RETAIL_AI_DATABRICKS_HOST

# =============================================================================
# MEMORY CONFIGURATION
# =============================================================================
# Configure persistent storage for agent conversations and context

memory: &memory
  # Conversation checkpointing for state persistence
  checkpointer: 
    name: default_checkpointer                      # Checkpointer identifier
    #type: postgres                                    # Store type (memory or postgres)
    type: memory
    database: *qsr_database                     # Reference to database configuration

  # Long-term memory store for agent context
  store: 
    name: default_store                             # Store identifier
    #type: postgres                                    # Store type (memory or postgres)
    type: memory
    embedding_model: *embedding_model               # Model for semantic memory
    dims: 1536                                      # Embedding dimensions
    database: *qsr_database                      # Database for persistence (if needed)
    namespace: "{user_id}"

# =============================================================================
# AGENTS CONFIGURATION
# =============================================================================
# Define specialized agents for different aspects of customer service
# Each agent has specific tools, capabilities, and responsibilities

agents:
  # ---------------------------------------------------------------------------
  # GENERAL AGENT
  # ---------------------------------------------------------------------------
  # Handles general store information and basic inquiries
  general: &general
    name: general                                   # Agent identifier
    description: "General retail store assistant for home improvement and hardware store inquiries"
    model: *tool_calling_llm                       # Reference to LLM configuration
    tools: 
      - *insert_coffee_order_tool
      - *match_item_by_description_and_price_tool
      - *match_historical_item_order_by_date_tool
      - *match_historical_item_order_by_date_tool
    memory: *memory                                 # Reference to memory configuration
    prompt: |                                       # System prompt defining agent behavior
      ### User Information
      - **User Id**: {user_id}
      - **Store Number**: {store_num}
      You are a helpful retail store assistant for a home improvement and hardware store. You have access to search tools to find general information 
      which can not be better answered by another agent.
    handoff_prompt: |                              
      General questions about store information, policies, hours, services, or basic product inquiries that don't require specialized expertise
      Example: "What are your store hours?" or "Do you offer installation services?" or "What's your return policy?"

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================
# Define the main application settings, registered model, endpoint configuration,
# and agent orchestration patterns for the multi-agent system

app:
  name: retai_ai_agent_example                      # Application name  
  description: "Multi-agent system for retail customer service and product assistance"
  log_level: DEBUG                                   # Logging level for the application
  registered_model:                                 # MLflow registered model configuration
    schema: *qsr_schema                          # Schema where model will be registered
    name: qsr_ai_agent                           # Model name in MLflow registry
  endpoint_name: qsr_ai_agent                    # Model serving endpoint name
  environment_vars: 
    PGHOST: "{{secrets/retail_ai/PGHOST}}"  # Databricks host URL
    RETAIL_AI_DATABRICKS_CLIENT_ID: "{{secrets/retail_ai/RETAIL_AI_DATABRICKS_CLIENT_ID}}"
    RETAIL_AI_DATABRICKS_CLIENT_SECRET: "{{secrets/retail_ai/RETAIL_AI_DATABRICKS_CLIENT_SECRET}}"
    RETAIL_AI_DATABRICKS_HOST: "{{secrets/retail_ai/RETAIL_AI_DATABRICKS_HOST}}"
  tags:                                             # Tags for resource organization
    business: rcg                                   # Business unit identifier
    streaming: true                                 # Indicates streaming capabilities
  permissions:                                      # Model serving permissions
    - principals: [users]                           # Grant access to all users
      entitlements:
        - CAN_MANAGE                                # Full management permissions
  agents:                                           # List of agents included in the system
    - *general  
  orchestration:                                    # Agent orchestration configuration
    supervisor:                                     # Supervisor orchestration pattern
      model: *tool_calling_llm                      # LLM for routing decisions
      memory: *memory                            # Memory store for conversation context
  message_hooks: 
    - retail.hooks.require_store_num_hook
  input_example:
      messages:
        - role: user
          content: How much is a green tea?
      custom_inputs:
        configurable:
          thread_id: "1"
          user_id: my_user_id
          store_num: 87887
  summarization:
    model: *tool_calling_llm

    # swarm:
    #   model: *tool_calling_llm
    #   default_agent: *general

# =============================================================================
# UNITY CATALOG FUNCTIONS DEPLOYMENT
# =============================================================================
# Define Unity Catalog functions to be deployed from SQL DDL files
# These functions provide data access capabilities for the agent tools

unity_catalog_functions:
  - function:
      schema: *qsr_schema
      name: lookup_items_by_descriptions
    ddl: ../functions/quick_serve_restaurant/lookup_items_by_descriptions.sql
    # test:
    #   parameters:
    #     sku: ["00176279"] 
  - function:
      schema: *qsr_schema
      name: match_historical_item_order_by_date
    ddl: ../functions/quick_serve_restaurant/match_historical_item_order_by_date.sql
  - function:
      schema: *qsr_schema
      name: match_item_by_description_and_price
    ddl: ../functions/quick_serve_restaurant/match_item_by_description_and_price.sql
  - function:
      schema: *qsr_schema
      name: insert_coffee_order
    ddl: ../functions/quick_serve_restaurant/insert_coffee_order.sql

# =============================================================================
# EVALUATION CONFIGURATION
# =============================================================================
# Configure automated evaluation settings for agent performance assessment

evaluation:
  model: *judge_llm
  table:
    schema: *qsr_schema
    name: evaluation
  num_evals: 25

# =============================================================================
# DATASETS CONFIGURATION
# =============================================================================
# Define source datasets for the system including table schemas, DDL files,
# and data files for initial population of Unity Catalog tables

datasets:
  - table: 
      schema: *qsr_schema
      name: orders_raw
    ddl: ../data/quick_serve_restaurant/orders_raw.sql
    data: ../data/quick_serve_restaurant/orders_raw.csv
    format: csv
    read_options:
      header: True
  - table: 
      schema: *qsr_schema
      name: items_raw
    ddl: ../data/quick_serve_restaurant/items_raw.sql
    data: ../data/quick_serve_restaurant/items_raw.csv
    format: csv
    read_options:
      header: True
    table_schema: |
      item_id STRING
      ,sku STRING
      ,item_name STRING
      ,item_cat STRING
      ,item_size STRING
      ,item_price DECIMAL(10,2)
  - table: 
      schema: *qsr_schema
      name: items_description
    ddl: ../data/quick_serve_restaurant/items_description.sql
    data: ../data/quick_serve_restaurant/items_description.csv
    read_options:
      header: True
      escape: "\""
      multiLine: True
    format: csv
  - table: 
      schema: *qsr_schema
      name: fulfil_item_orders
    ddl: ../data/quick_serve_restaurant/fulfil_item_orders.sql




    
