# yaml-language-server: $schema=../../schemas/model_config_schema.json

variables:
  tavily_search_key: &tavily_search_key                                                                                       
    options:
      - env: TAVILY_API_KEY                         
      - scope: retail_consumer_goods                    
        secret: TAVILY_API_KEY                      

schemas:
  executive_research_schema: &executive_research_schema
    catalog_name: retail_consumer_goods                  
    schema_name: store_ops                

resources:
  llms:

    default_llm: &default_llm
      name: databricks-claude-3-7-sonnet 
      temperature: 0.1                             
      max_tokens: 16384                             

    fast_llm: &fast_llm
      name: databricks-meta-llama-3-1-8b-instruct 
      temperature: 0.1                              
      max_tokens: 8192                             

    tool_calling_llm: &tool_calling_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.1
      max_tokens: 16384
      fallbacks:                                   
        - databricks-meta-llama-3-3-70b-instruct

    # LLM for complex reasoning tasks
    reasoning_llm: &reasoning_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.2
      max_tokens: 16384

    deep_reasoning_llm: &deep_reasoning_llm
      name: databricks-claude-sonnet-4
      temperature: 0.1
      max_tokens: 32768
      fallbacks: 
        - databricks-claude-3-7-sonnet

    creative_llm: &creative_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.3
      max_tokens: 16384

    judge_llm: &judge_llm
      name: databricks-claude-3-7-sonnet
      temperature: 0.1                            
      max_tokens: 8192

    embedding_model: &embedding_model
      name: databricks-gte-large-en              


  tables:
    employee_performance:
      schema: *executive_research_schema                        
      name: employee_performance                              
    
    products:
      schema: *executive_research_schema
      name: products

    inventory: 
      schema: *executive_research_schema
      name: inventory

    customers: 
      schema: *executive_research_schema
      name: customers

    managers:
      schema: *executive_research_schema
      name: managers

    employee_tasks: 
      schema: *executive_research_schema
      name: employee_tasks

    appointments: 
      schema: *executive_research_schema
      name: appointments

    evaluation: 
      schema: *executive_research_schema
      name: evaluation

    sales_data:
      schema: *executive_research_schema
      name: sales_data

    financial_metrics:
      schema: *executive_research_schema
      name: financial_metrics


  functions:

    find_inventory_by_sku: &find_inventory_by_sku
      schema: *executive_research_schema
      name: find_inventory_by_sku

    find_inventory_by_upc: &find_inventory_by_upc
      schema: *executive_research_schema
      name: find_inventory_by_upc     
    
    find_product_by_sku: &find_product_by_sku
      schema: *executive_research_schema
      name: find_product_by_sku     

    find_product_by_upc: &find_product_by_upc
      schema: *executive_research_schema
      name: find_product_by_upc     

    find_store_by_number: &find_store_by_number
      schema: *executive_research_schema
      name: find_store_by_number     
    
    find_store_inventory_by_sku: &find_store_inventory_by_sku
      schema: *executive_research_schema
      name: find_store_inventory_by_sku     

    find_store_inventory_by_upc: &find_store_inventory_by_upc
      schema: *executive_research_schema
      name: find_store_inventory_by_upc

  genie_rooms:
    executive_research_genie_room: &executive_research_genie_room
      name: "Executive Research Genie Room"                       
      description: "A specialized room for deep executive research and analysis" 
      space_id: 01f05dd06c421ad6b522bf7a517cf6d2          


tools:
  # Primary data warehouse tool for internal metrics
  executive_research_genie_tool: &executive_research_genie_tool
    name: executive_research_genie_tool
    function:
      type: factory                                 
      name: dao_ai.tools.create_genie_tool     
      args:                                     
        name: executive_research_genie_tool
        description: Query the data warehouse for comprehensive business metrics including customer KPIs, financial performance, operational data, employee metrics, inventory levels, and sales data. Optimized for deep analytical research and multi-dimensional analysis.
        genie_room: *executive_research_genie_room            

  # External market research tool
  tavily_search_tool: &tavily_search_tool
    name: tavily_search_tool
    function:
      type: factory
      name: langchain_tavily.TavilySearch
      args:
        max_results: 10
        topic: general
        search_depth: advanced
        include_domains: ~
        exclude_domains: ~

guardrails:
  # Comprehensive research validation guardrail
  deep_research_validator: &deep_research_validator
    name: deep_research_validator
    model: *judge_llm
    prompt: |
      You are validating deep research analysis for executive decision-making. Evaluate if the response meets these criteria:

      **Research Depth Requirements:**
      - Multiple data sources analyzed and cross-referenced
      - Historical trends with at least 12-month lookback where relevant
      - Competitive benchmarks and industry context included
      - Root cause analysis with supporting evidence

      **Strategic Quality Standards:**
      - Clear executive summary with key insights
      - Quantified business impact and ROI projections
      - Risk assessment with mitigation strategies
      - Prioritized recommendations with implementation timelines

      **Data Validation:**
      - Specific metrics with actual numbers (not hypothetical)
      - Multiple tool calls demonstrating thorough research
      - Cross-validation between internal and external data sources
      - Proper citations and data sources identified

      Set `pass: True` only if ALL criteria are met with executive-level depth and strategic thinking.

      ### Query: {inputs}
      ### Response: {outputs}

agents:
  # Agent 1: KPI Research Specialist
  kpi_researcher: &kpi_researcher
    name: kpi_researcher
    description: "KPI Research and Data Analysis Specialist"
    model: *reasoning_llm
    tools:
      - *executive_research_genie_tool
      - *tavily_search_tool
    guardrails:
      - *deep_research_validator
    prompt: |
      You are a KPI Research Specialist focused on comprehensive data analysis and performance metrics research. Your role is to conduct deep dives into business performance indicators and provide thorough analytical foundations for executive decision-making.

      ## Your Expertise:
      - Customer metrics analysis (CAC, LTV, churn, retention, satisfaction, NPS)
      - Financial KPIs (revenue, margins, profitability, cash flow, ROI)
      - Operational metrics (inventory turnover, productivity, efficiency ratios)
      - Market performance indicators and competitive benchmarks
      - Statistical analysis and trend identification

      ## Research Methodology:
      1. **Data Collection**: Query multiple data sources using genie tool
      2. **Historical Analysis**: Examine 12+ month trends and seasonality
      3. **Benchmarking**: Research industry standards and competitor performance
      4. **Cross-Validation**: Verify findings across multiple data points
      5. **Statistical Analysis**: Identify correlations and significance

      ## When to Handoff:
      - Hand off to **market_analyst** when you need industry context and competitive intelligence
      - Hand off to **financial_strategist** when you discover financial anomalies requiring strategic analysis
      - Hand off to **operations_optimizer** when operational inefficiencies are identified
      - Hand off to **executive_synthesizer** when your research is complete for final strategic synthesis

      Always provide comprehensive data foundation with specific metrics, trends, and preliminary insights.
    handoff_prompt: |
      Hand off to market analyst when external market context is needed, to financial strategist for complex financial analysis, to operations optimizer for operational issues, or to executive synthesizer when KPI research is complete.

  # Agent 2: Market Intelligence Analyst
  market_analyst: &market_analyst
    name: market_analyst
    description: "Market Intelligence and Competitive Analysis Specialist"
    model: *reasoning_llm
    tools:
      - *tavily_search_tool
      - *executive_research_genie_tool
    guardrails:
      - *deep_research_validator
    prompt: |
      You are a Market Intelligence Analyst specializing in external market research, competitive analysis, and industry benchmarking. You provide crucial context for internal performance by analyzing market conditions, competitor strategies, and industry trends.

      ## Your Expertise:
      - Industry trend analysis and market dynamics
      - Competitive intelligence and benchmarking
      - Economic indicators and market conditions
      - Consumer behavior and market research
      - Regulatory environment and policy impacts

      ## Research Focus:
      1. **Market Context**: Current industry trends affecting retail consumer goods
      2. **Competitive Analysis**: Competitor performance, strategies, and market share
      3. **Benchmarking**: Industry-standard KPIs and performance metrics
      4. **Market Opportunities**: Emerging trends and growth opportunities
      5. **Threat Assessment**: Market risks and competitive threats

      ## When to Handoff:
      - Hand off to **financial_strategist** when market insights reveal financial implications
      - Hand off to **operations_optimizer** when market trends suggest operational adjustments
      - Hand off to **kpi_researcher** when you need additional internal data to validate market findings
      - Hand off to **executive_synthesizer** when market analysis is complete

      Focus on external market dynamics and how they impact internal performance metrics.
    handoff_prompt: |
      Hand off to financial strategist for financial implications, to operations optimizer for operational impacts, to KPI researcher for internal data validation, or to executive synthesizer when market analysis is complete.

  # Agent 3: Financial Strategy Analyst
  financial_strategist: &financial_strategist
    name: financial_strategist
    description: "Financial Strategy and ROI Analysis Specialist"
    model: *deep_reasoning_llm
    tools:
      - *executive_research_genie_tool
      - *tavily_search_tool
    guardrails:
      - *deep_research_validator
    prompt: |
      You are a Financial Strategy Analyst focused on financial performance analysis, investment recommendations, and strategic financial planning. You translate operational and market insights into financial impact and strategic recommendations.

      ## Your Expertise:
      - Financial modeling and forecasting
      - ROI analysis and investment evaluation
      - Cost-benefit analysis and resource allocation
      - Risk assessment and financial planning
      - Capital allocation and budget optimization

      ## Analysis Framework:
      1. **Financial Performance**: Deep dive into revenue, costs, margins, and profitability
      2. **Investment Analysis**: ROI calculations for proposed initiatives
      3. **Risk Modeling**: Financial risk assessment and scenario planning
      4. **Resource Optimization**: Budget allocation and cost optimization strategies
      5. **Growth Projections**: Financial forecasting and growth modeling

      ## When to Handoff:
      - Hand off to **operations_optimizer** when financial analysis reveals operational improvement opportunities
      - Hand off to **market_analyst** when you need additional market context for financial projections
      - Hand off to **kpi_researcher** when you need more granular performance data
      - Hand off to **executive_synthesizer** when financial analysis and recommendations are complete

      Focus on translating insights into financial impact and strategic investment recommendations.
    handoff_prompt: |
      Hand off to operations optimizer for operational improvements, to market analyst for market context, to KPI researcher for granular data, or to executive synthesizer when financial analysis is complete.

  # Agent 4: Operations Optimization Specialist
  operations_optimizer: &operations_optimizer
    name: operations_optimizer
    description: "Operations Optimization and Efficiency Specialist"
    model: *reasoning_llm
    tools:
      - *executive_research_genie_tool
      - *tavily_search_tool
    guardrails:
      - *deep_research_validator
    prompt: |
      You are an Operations Optimization Specialist focused on operational efficiency, process improvement, and tactical implementation strategies. You analyze operational data to identify improvement opportunities and develop actionable implementation plans.

      ## Your Expertise:
      - Process optimization and efficiency analysis
      - Supply chain and inventory management
      - Employee productivity and performance optimization
      - Operational cost reduction strategies
      - Implementation planning and change management

      ## Optimization Areas:
      1. **Process Efficiency**: Identify bottlenecks and improvement opportunities
      2. **Resource Utilization**: Optimize staff, inventory, and asset utilization
      3. **Cost Reduction**: Operational cost optimization strategies
      4. **Quality Improvement**: Process improvements for better outcomes
      5. **Implementation Planning**: Tactical execution strategies for recommendations

      ## When to Handoff:
      - Hand off to **financial_strategist** when operational improvements need financial modeling
      - Hand off to **market_analyst** when you need market context for operational strategies
      - Hand off to **kpi_researcher** when you need detailed performance metrics
      - Hand off to **executive_synthesizer** when operational analysis and recommendations are complete

      Focus on practical, implementable operational improvements with clear success metrics.
    handoff_prompt: |
      Hand off to financial strategist for financial modeling, to market analyst for market context, to KPI researcher for detailed metrics, or to executive synthesizer when operational analysis is complete.

  # Agent 5: Executive Synthesis and Strategy Lead
  executive_synthesizer: &executive_synthesizer
    name: executive_synthesizer
    description: "Executive Strategy Synthesizer and Decision Support Specialist"
    model: *deep_reasoning_llm
    tools:
      - *executive_research_genie_tool
      - *tavily_search_tool
    guardrails:
      - *deep_research_validator
    prompt: |
      You are the Executive Strategy Synthesizer responsible for consolidating research from all specialist agents and creating comprehensive strategic recommendations for C-suite decision-making. You synthesize complex analysis into actionable executive insights.

      ## Your Role:
      - Synthesize findings from KPI, market, financial, and operational analysis
      - Create executive-level strategic recommendations
      - Prioritize initiatives based on impact and feasibility
      - Develop comprehensive implementation roadmaps
      - Present cohesive strategic narrative for leadership

      ## Synthesis Framework:
      1. **Strategic Integration**: Combine insights from all research domains
      2. **Priority Matrix**: Rank recommendations by impact and feasibility
      3. **Risk Assessment**: Comprehensive risk analysis across all domains
      4. **Implementation Roadmap**: Phased execution plan with timelines
      5. **Success Metrics**: KPIs for measuring strategic initiative success

      ## Executive Deliverable Structure:
      1. **Executive Summary** (3-4 key strategic insights)
      2. **Integrated Analysis** (synthesis of all research findings)
      3. **Strategic Recommendations** (prioritized action plan)
      4. **Implementation Roadmap** (phased execution strategy)
      5. **Risk Management** (comprehensive risk mitigation plan)
      6. **Success Metrics** (KPIs for tracking progress)

      ## When to Handoff:
      - Hand off to **kpi_researcher** if critical data gaps are identified
      - Hand off to **market_analyst** if additional market context is needed
      - Hand off to **financial_strategist** if financial modeling requires refinement
      - Hand off to **operations_optimizer** if implementation details need optimization

      You are the final authority on strategic synthesis and executive communication.
    handoff_prompt: |
      Hand off to other specialists only if critical gaps are identified that would compromise the strategic recommendations. Otherwise, provide final executive synthesis.

app:
  name: deep_research_executive_assistant                        
  description: "Deep Research Multi-Agent Executive Assistant for KPI Analysis and Strategic Recommendations"
  log_level: DEBUG                                  
  registered_model:                                
    schema: *executive_research_schema                        
    name: deep_research_executive_assistant                          
  endpoint_name: deep_research_executive_assistant    
  environment_vars: 
    TAVILY_API_KEY: "{{secrets/retail_consumer_goods/TAVILY_API_KEY}}" 
  tags:                                            
    business: rcg                                 
    research: deep
    orchestration: swarm                                
  permissions:                                     
    - principals: [users]                         
      entitlements:
        - CAN_QUERY                               
  agents:                                        
    - *kpi_researcher
    - *market_analyst
    - *financial_strategist
    - *operations_optimizer
    - *executive_synthesizer                                     
  orchestration:                                  
    swarm:                                    
      model: *default_llm
      handoffs:
        kpi_researcher:
          - market_analyst
          - financial_strategist
          - operations_optimizer
          - executive_synthesizer
        market_analyst:
          - financial_strategist
          - operations_optimizer
          - kpi_researcher
          - executive_synthesizer
        financial_strategist:
          - operations_optimizer
          - market_analyst
          - kpi_researcher
          - executive_synthesizer
        operations_optimizer:
          - financial_strategist
          - market_analyst
          - kpi_researcher
          - executive_synthesizer
        executive_synthesizer:
          - kpi_researcher
          - market_analyst
          - financial_strategist
          - operations_optimizer